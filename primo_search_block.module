<?php
/**
 * @file primo_search_block.module
 * TODO: Enter file description here.
 */



/**
 * Implements hook_block_info().
 */
function primo_search_block_block_info() {
  $blocks = array(
    'primo_search_block' => array(
        'info' => t('Primo Search Block'),
        'cache' => DRUPAL_CACHE_GLOBAL,
      ),
    );
  return $blocks;
}

/**
 * Builds the select element for the scopes list.
 * @param  array  $scopes Associative array of label to value
 * @return string         Markup to be added to the form.
 */
function primo_search_block_scopes_select(array $scopes){
  $markup = '';
  foreach ($scopes as $label => $value) {
    $markup .= '<option value="'. $value.'">'.$label.'</option>';
  }

  $markup = '<select name="search_scope">'.$markup.'</select>';
  return $markup;
}

/**
 * Implements hook_block_view().
 */
function primo_search_block_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'primo_search_block':

      $searchScopes = (array) variable_get('primo_search_search_scope', array(
        'Library Catalogs + Articles' => 'everything_scope',
        'Library Catalogs' => 'nu_scope',
        'Law Library Catalog' => 'nu_law',
        'Course Reserves' => 'nu_cr',
        )
      );
      $searchScopes = array_flip($searchScopes);
      
      foreach ($searchScopes as $key => $value) {
        $searchScopes[$key] = t($value);
      }
      $modulePath = drupal_get_path('module', 'primo_search_block');

      $additionalMarkup = variable_get('primo_search_block_additional_markup', array(
        'format' => null,
        'value' => null,
        )
      );
      dpm($additionalMarkup);

      $block['subject'] = t(variable_get('primo_search_block_title', 'Primo Search'));
      $block['content'] = array(
          'searchForm'=> array(
            '#type'=> 'form',
            '#method' => 'get',
            '#action' => url('http://'. variable_get('primo_search_block_url','onesearch.northeastern.edu:1701'). '/primo_library/libweb/action/dlSearch.do'),
            '#attributes'=> array(
              'onsubmit' => 'searchPrimo()',
              'name' => 'searchForm',
              'role'=>'search',
              ),
            'institution' => array(
              '#type'=> 'hidden',
              '#value'=> variable_get('primo_search_block_institution_code','NEU'),
              '#attributes'=> array(
                'name'=> 'institution',
                ),
              ),
            'vid' => array(
              '#type'=> 'hidden',
              '#value'=> variable_get('primo_search_block_view_code', 'NU'),
              '#attributes'=> array(
                'name'=> 'vid',
                ),
              ),
            'group' => array(
              '#type'=> 'hidden',
              '#value'=> 'GUEST',
              '#attributes'=> array(
                'name'=> 'group',
                ),
              ),
            'onCampus' => array(
              '#type'=> 'hidden',
              '#value'=> 'true',
              '#attributes'=> array(
                'name'=> 'onCampus',
                ),
              ),
            'displayMode' => array(
              '#type'=> 'hidden',
              '#value'=> 'full',
              '#attributes'=> array(
                'name'=> 'displayMode',
                ),
              ),
            'query' => array(
              '#type'=> 'hidden',
              '#attributes'=> array(
                'name'=> 'query',
                'id'=> 'primoQuery',
                ),
              ),
            'queryTemp' => array(
              '#type'=> 'textfield',
              '#required' => TRUE,
              '#attributes'=> array(
                'onkeypress' =>'return searchPrimoEvent(event)',
                'name'=> 'primoQueryTemp',
                'id'=> 'primoQueryTemp',
                'placeholder'=> variable_get('primo_search_block_placeholder', 'Search NU Libraries & More'),
                )
              ),
            'searchScopes' => array(
              '#type' => 'select',
              '#options' => $searchScopes,
              '#attributes'=> array(
                'name'=>'search_scope'
                )
              ),
            'searchSubmit'=> array(
              '#type'=> 'submit',
              '#value'=> 'Search',
              '#attributes' => array(
                'id'=> 'go',
                'onclick'=> 'searchPrimo()',
                'alt'=>'search',
                ),
              ),
            'additionalMarkup' => array(
              '#type'=> 'markup',
              '#markup'=> check_markup($additionalMarkup['value'], $additionalMarkup['format']),
              ),
            ),
          '#attached' => array(
            'js' => array( $modulePath . '/js/primo_search_block.min.js'),
          ),

        );
    break;
  }
  return $block;
}

/**
 * Implements hook_block_configure().
 */
function primo_search_block_block_configure($delta = '') {
  $form = array();
   if ($delta == 'primo_search_block') {

    $additionalMarkup = variable_get('primo_search_block_additional_markup', array(
        'format' => null,
        'value' => null,
        )
    );
    $form['primo_search_block_scope_json'] = array(
      '#type' => 'textfield',
      '#title' => t('Search scopes'),
      '#default_value' => variable_get('primo_search_block_scope_json'
        ,'{"Library Catalogs + Articles":"everything_scope","Library Catalogs":"nu_scope","Law Library Catalog":"nu_law","Course Reserves":"nu_cr"}'
        ),
      '#required' => True,
      '#size'=> 200,
      '#maxlength'=> 999,
      '#element_validate' => array('primo_search_block_json_validate'),
      );

    $form['primo_search_block_institution_code']= array(
      '#type' => 'textfield',
      '#title' => t('Institution Code'),
      '#default_value'=> variable_get('primo_search_block_institution_code', 'NEU'),
      '#required' => True
      );
    
    $form['primo_search_block_url']= array(
      '#type' => 'textfield',
      '#title' => t('Primo\'s Url and Port'),
      '#default_value' => variable_get('primo_search_block_url', 'onesearch.northeastern.edu:1701'),
      '#required' => True,
      );
    $form['primo_search_block_view_code'] = array(
      '#type' => 'textfield',
      '#title' => t('View code.'),
      '#default_value'=> variable_get('primo_search_block_view_code', 'NU'),
      '#required' => True,
      );
    $form['primo_search_block_additional_markup'] = array(
      '#type'=>'text_format',
      '#title' => t('Additional markup to add to the block'),
      '#default_value' => $additionalMarkup['value'],
      '#format' => $additionalMarkup['format'],
      );
    $form['primo_search_block_placeholder'] = array(
      '#type'=>'textfield',
      '#title'=> t('Search placeholder for the search field'),
      '#default_value' => variable_get('primo_search_block_placeholder', 'Search NU Libraries & More'),

      );
    $form['primo_search_block_advanced_search'] = array(
      '#type'=>'textfield',
      '#title'=> t('Advanced Search Link'),
      '#default_value' => variable_get('primo_search_block_advanced_search', null),
      );
    $form['primo_search_block_browse_search'] = array(
      '#type'=>'textfield',
      '#title'=> t('Browse Search Link'),
      '#default_value' => variable_get('primo_search_block_browse_search', null),
      );
    $form['primo_search_block_help'] = array(
      '#type' => 'textfield',
      '#title' => t('Search help link'),
      '#defualt_value' =>  variable_get('primo_search_block_help', null),
      );
    $form['primo_search_block_ext_link_json'] = array(
      '#type' => 'textfield',
      '#title' => t('External links'),
      '#default_value' => variable_get('primo_search_block_ext_link_json',
        '{"Google Scholar":"http://scholar.google.com/schhp?hl=en&inst=12820075384204861865","WorldCat":"http://northeastern.worldcat.org"}'),
      '#size'=> 200,
      '#maxlength'=> 999,
      '#element_validate' => array('primo_search_block_json_validate'),
      '#description' => t('To add additional links to the to the Primo Search block, please enter JSON formated data. For example <code>{"Title":"URL","Title 2":"URL 2"}</code>. All links will be formated as external links.'),
      );
   }
  return $form;
}

/**
 * Form search scope validation funtion.
 * @param  array $element the returne form element.
 */
function primo_search_block_json_validate($element, &$form_state, $form){
  $test = @json_decode($element['#value']);
  if ($test === null && json_last_error() !== JSON_ERROR_NONE) {
    form_set_error('primo_search_search_scope_json', t('Please enter valid JSON.'));
  }
}



/**
 * Implements hook_block_save().
 */
function primo_search_block_block_save($delta = '', $edit = array()) {
  if ($delta == 'primo_search_block'){
    variable_set('primo_search_block_scope_json', $edit['primo_search_block_scope_json']);
    variable_set('primo_search_block_scope_array', json_decode($edit['primo_search_block_scope_json'],True));
    variable_set('primo_search_block_view_code', $edit['primo_search_block_view_code']);
    variable_set('primo_search_block_institution_code', $edit['primo_search_block_institution_code']);
    variable_set('primo_search_block_url', $edit['primo_search_block_url']);
    variable_set('primo_search_block_additional_markup', $edit['primo_search_block_additional_markup']);
    variable_set('primo_search_block_placeholder', $edit['primo_search_block_placeholder']);
    variable_set('primo_search_block_advanced_search', $edit['primo_search_block_advanced_search']);
    variable_set('primo_search_block_browse_search', $edit['primo_search_block_browse_search']);
    variable_set('primo_search_block_ext_link_json', $edit['primo_search_block_ext_link_json']);
    variable_set('primo_search_block_ext_link_array', json_decode($edit['primo_search_block_ext_link_json'],True));
  }

}
